{% extends "bill/_base.html" %}

{% load static %}
{% load i18n %}
{% load render_materialized_field from wl_forms %}


{% comment TODO by dirleyrls %}{#
    1. Definir o foco inicial pro campo `content`.
    3. Exibir um "campo" que permita ao usuário exibir/esconder o conteúdo original.
#}{% endcomment %}

{% block content3 %}
    <div class="col m8 pl-full">
        <div class="row">
            <h4>{% trans "Send proposal" %}</h4>

            <form class="col s12" action="./" method="POST">
                {% csrf_token %}

                {{ form.non_field_errors }}

                <div class="row propose">
                    <div class="input-field col s12">
                        <i class="material-icons prefix">mode_edit</i>
                        {% render_materialized_field form.content extra_classes="materialize-textarea" data_original_content=form.initial.content|escape %}
                    </div>
                </div>

                <div class="row propose">
                    <div class="input-field col s12">
                        <p id="content-output"></p>
                    </div>
                </div>

                <div class="row">
                  <div class="col s11 offset-s1">
                    <div class="input-field col s12">
                        <i class="material-icons prefix">comment</i>
                        {% render_materialized_field form.comment extra_classes="materialize-textarea" %}
                    </div>
                  </div>
                </div>

                <div class="row">
                    <div class="col s12 right-align">
                        <a class="btn waves-effect waves-light" href="{% url "show_segment" segment.bill.id segment.id %}">{% trans "Cancel" %}</a>
                        <button class="btn waves-effect waves-light" type="submit" name="action">{% trans "Send proposal" %}
                            <i class="material-icons right">send</i>
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>
{% endblock %}

{% block partialscript %}
    <script type="text/javascript" src="{% static "js/jsdiff.js" %}"></script>
    <script type="text/javascript">
        function doTheDiff(e) {
            var $field = $(e.target);

            var splitinput = ($field.attr('data-original-content') || "").split('\n');
            var splitoutput = ($field.val() || "").split('\n');

            var lines = Math.max(splitinput.length, splitoutput.length);

            var buildoutput = "";
            for (var i = 0; i < lines; i++)
            {
                var testundefined = false;

                if (typeof splitinput[i] === 'undefined') {
                    buildoutput=buildoutput+diffString("",splitoutput[i]);
                    testundefined=true;
                }

                if (typeof splitoutput[i] === 'undefined') {
                    buildoutput=buildoutput+diffString(splitinput[i],"");
                    testundefined=true;
                }

                if (!testundefined) {
                    buildoutput=buildoutput+diffString(splitinput[i],splitoutput[i]);
                }
            }

            $("#content-output").html(buildoutput);
        }

        $(function() {
          $("#{{ form.content.id_for_label }}").focus().on('change', doTheDiff);
        });
    </script>
{% endblock %}